# learn-sdn-hub

## Prerequisites

Both the host running the backend and frontend as well as the VM or host executing the p4 environment need node.js. To install it, you can use nvm:

```
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
nvm install 15
bash
```

Make sure to close and reopen the shell afterwards to have nvm automatically in your environment.

## Installation

```
git clone https://github.com/prona-p4-learning-platform/learn-sdn-hub.git
cd learn-sdn-hub
cd backend
npm install
npm run compile
cd ..
cd frontend
npm install
npm run build
```

## Prepare a host (e.g. virtual machine/image) to be used by the backend to run p4 code and the language server for vscode

Easiest way to get started is using the [p4 tutorials VM](https://github.com/p4lang/tutorials) and run it in VirtualBox or another hypervisor. You also need to give the
machine an IP address that can be reached from the backend (see providers in next steps). You can also prepare a Ubuntu VM by using the 
[installation scripts](https://github.com/jafingerhut/p4-guide/blob/master/bin/install-p4dev-v2.sh) from the p4 guide
repo. By default and for the following example configuration, we assume the VM to have a user p4 with password p4 (as the default for the p4 tutorial vms).

To install the LSP and the LSP load balancer in the VM, run the following in the VM (currently using latest feature version of node, hence 15):

```
git clone https://github.com/wylieconlon/jsonrpc-ws-proxy
cd jsonrpc-ws-proxy
npm install
npm run prepare
```

Create a servers.yml file in the jsonrpc-ws-proxy directory containing the location of the p4 LSP, e.g.:

```
langservers:
  p4:
    - node
    - /home/p4/p4-vscode-extension/server/build/server.js
    - --stdio
```

You can add further LSP so support additional languages in the LSP load balancer.
Install the p4 vscode extension in the VM (make sure that it will be in the location you specified in servers.yml file above, in 
this case ```/home/p4/p4-vscode-extension/server/build/server.js```):

```
git clone https://github.com/prona-p4-learning-platform/p4-vscode-extension.git
cd p4-vscode-extension
npm install
cd server
npm run build
cp -a src/antlr_autogenerated build/
```

Start the LSP load balancer:

```
node dist/server.js --port 3005 --languageServers servers.yml
```

If everything went well, you should make sure that the LSP load balancer is started automatically when the VM starts. You can use a systemd unit like this for that:

```
[Unit]
Description=LSP load balancer server
After=network.target

[Service]
Type=simple
Restart=always
RestartSec=1
KillMode=process
User=p4
WorkingDirectory=/home/p4/jsonrpc-ws-proxy
ExecStart=/home/p4/.nvm/versions/node/v15.4.0/bin/node dist/server.js --port 3005 --languageServers servers.yml

[Install]
WantedBy=multi-user.target
Alias=lsp-loadbalancer.service
```


## Run the environment using a local VM ([LocalVMProvider.ts](https://github.com/prona-p4-learning-platform/learn-sdn-hub/blob/master/backend/src/providers/LocalVMProvider.ts))

You can use a virtual machine or a physical or even your local machine and specify the IP address to be used by the backend. The machine must contain p4 tool chain
and needs to be reachable using SSH. Also, it should run the LSP load balancer, as described above. Start the backend:

```
export VBOX_IP_ADDRESS=<IP address of the virtual machine>
cd backend
npm run start:localvm
```

To run the frontend, you need to creat frontend config file as ".env.local" file in the frontend directory:

```
REACT_APP_API_HOST=http://localhost:3001
REACT_APP_WS_HOST=ws://localhost:3001
```

You need to adapt "localhost" in the .env.local file if your backend is not running on the same host as the frontend.
After creating the file, run the frontend by issuing:

```
cd frontend
npm run start
```

A web browser will open automatically leading you to the login in the frontend. If you use the demo authentication provider, you can use user "test123" and password "test123". 

Configuration changes regarding assignments etc. need to be done in backend/src/Configuration.ts. Assignment lab sheets need to be stored in backend/src/assigments.

## Run the environment using OpenStack ([OpenStackProvider.ts](https://github.com/prona-p4-learning-platform/learn-sdn-hub/blob/master/backend/src/providers/OpenStackProvider.ts))

t.b.d. (to be documented ;))
